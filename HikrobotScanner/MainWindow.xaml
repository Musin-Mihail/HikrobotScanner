<Window x:Class="HikrobotScanner.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="Hikrobot ID5000 Controller (MVVM Refactored)" Height="850" Width="700"
        WindowStartupLocation="CenterScreen"
        Closing="Window_Closing">

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <GroupBox Header="Настройки подключения" Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2" Padding="10">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <Label Content="IP камеры 1:" Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" />
                <TextBox Text="{Binding Settings.CameraIp, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Grid.Row="0" Grid.Column="1" Margin="5" VerticalAlignment="Center" />

                <Label Content="Локальный порт 1 (прием):" Grid.Row="0" Grid.Column="2" VerticalAlignment="Center" />
                <TextBox Text="{Binding Settings.ListenPort, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Grid.Row="0" Grid.Column="3" Margin="5" VerticalAlignment="Center" />

                <Label Content="Ожидаемое кол-во QR кодов:" Grid.Row="2" Grid.Column="0" VerticalAlignment="Center" />
                <ComboBox SelectedIndex="{Binding Settings.ExpectedPartsIndex, Mode=TwoWay}" Grid.Row="2" Grid.Column="1" Margin="5" VerticalAlignment="Center">
                    <ComboBoxItem Content="6" />
                    <ComboBoxItem Content="8" />
                </ComboBox>

                <Label Content="Профиль настроек камеры 1:" Grid.Row="2" Grid.Column="2" VerticalAlignment="Center" />
                <ComboBox SelectedIndex="{Binding Settings.UserSetIndex, Mode=TwoWay}" Grid.Row="2" Grid.Column="3" Margin="5" VerticalAlignment="Center">
                    <ComboBoxItem Content="UserSet1" />
                    <ComboBoxItem Content="UserSet2" />
                    <ComboBoxItem Content="UserSet3" />
                </ComboBox>

                <Label Content="IP камеры 2:" Grid.Row="3" Grid.Column="0" VerticalAlignment="Center" />
                <TextBox Text="{Binding Settings.CameraIp2, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Grid.Row="3" Grid.Column="1" Margin="5" VerticalAlignment="Center" />

                <Label Content="Локальный порт 2 (прием):" Grid.Row="3" Grid.Column="2" VerticalAlignment="Center" />
                <TextBox Text="{Binding Settings.ListenPort2, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Grid.Row="3" Grid.Column="3" Margin="5" VerticalAlignment="Center" />

                <Label Content="Профиль настроек камеры 2:" Grid.Row="5" Grid.Column="2" VerticalAlignment="Center" />
                <ComboBox SelectedIndex="{Binding Settings.UserSetIndex2, Mode=TwoWay}" Grid.Row="5" Grid.Column="3" Margin="5" VerticalAlignment="Center">
                    <ComboBoxItem Content="UserSet1" />
                    <ComboBoxItem Content="UserSet2" />
                    <ComboBoxItem Content="UserSet3" />
                </ComboBox>
            </Grid>
        </GroupBox>

        <GroupBox Header="Управление и Результат" Grid.Row="1" Grid.Column="0" Padding="10">
            <StackPanel>
                <Button Content="Старт сервера" Command="{Binding StartServerCommand}" Margin="5" Padding="10,5" />
                <Button Content="Стоп сервера" Command="{Binding StopServerCommand}" Margin="5" Padding="10,5" />
                <Button Content="Очистить базу данных" Command="{Binding ClearDatabaseCommand}" Margin="5" Padding="10,5" />
            </StackPanel>
        </GroupBox>

        <GroupBox Header="Генерация кодов" Grid.Row="1" Grid.Column="1" Padding="10">
            <StackPanel>
                <Label Content="Следующий номер кода:" />
                <TextBlock Text="{Binding BarcodeCounterDisplay, Mode=OneWay}" FontWeight="Bold" Margin="5,0,5,10" FontSize="14" />
                <Label Content="Количество для генерации:" />
                <TextBox Text="{Binding BarcodeQuantity, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Margin="5,0,5,5" />
                <Button Content="Сгенерировать и напечатать" Command="{Binding GenerateBarcodesCommand}" Margin="5" Padding="10,5" />
            </StackPanel>
        </GroupBox>

        <GroupBox Header="Лог событий" Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Padding="10">
            <TextBox x:Name="LogTextBox" 
                     Text="{Binding LogText, Mode=OneWay}" 
                     IsReadOnly="True" 
                     TextWrapping="Wrap" 
                     VerticalScrollBarVisibility="Auto" 
                     Background="#f0f0f0" 
                     TextChanged="LogTextBox_TextChanged" />
        </GroupBox>

        <StatusBar Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusText, Mode=OneWay}" />
            </StatusBarItem>
        </StatusBar>

        <Border Grid.Row="0" Grid.Column="0" 
                Grid.RowSpan="4" Grid.ColumnSpan="2" Background="Transparent"
                IsHitTestVisible="False" x:Name="ErrorFlashOverlay">

            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Background" Value="Transparent" />
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsErrorState}" Value="True">
                            <DataTrigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <ColorAnimation Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)"
                                                        To="#66FF0000" Duration="0:0:0.25" AutoReverse="True" RepeatBehavior="3x" />
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.EnterActions>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>
        </Border>
    </Grid>
</Window>
